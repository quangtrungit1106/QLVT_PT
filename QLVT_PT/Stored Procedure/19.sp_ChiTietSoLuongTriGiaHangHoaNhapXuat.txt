CREATE PROCEDURE [dbo].[sp_ChiTietSoLuongTriGiaHangHoaNhapXuat]
@ROLE NVARCHAR(8),
@TYPE NVARCHAR(4),
@DATEFROM DATETIME,
@DATETO DATETIME
AS
BEGIN
	IF( @ROLE = 'CONGTY')
	BEGIN
		IF(@TYPE = 'NHAP')
		BEGIN
				SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, 
						TENVT, 
						SUM(SOLUONG) AS TONGSOLUONG,
						SUM(SOLUONG * DONGIA) AS TRIGIA
				FROM
					( SELECT NGAY,MAPN 
						FROM PhieuNhap
						WHERE NGAY BETWEEN @DATEFROM AND @DATETO   )PHIEU,
					( SELECT TENVT,MAVT FROM Vattu ) VT,
					( SELECT SOLUONG, DONGIA, MAPN,MAVT FROM CTPN) CT
				WHERE PHIEU.MAPN = CT.MAPN
				AND VT.MAVT = CT.MAVT
				GROUP BY FORMAT(NGAY,'MM-yyyy'), TENVT
				ORDER BY FORMAT(NGAY,'MM-yyyy'), TENVT
		END

		ELSE
		BEGIN
					SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, 
						TENVT, 
						SUM(SOLUONG) AS TONGSOLUONG,
						SUM(SOLUONG * DONGIA) AS TRIGIA
					FROM
						( SELECT NGAY,MAPX
							FROM PhieuXuat
							WHERE NGAY BETWEEN @DATEFROM  AND @DATETO   )PHIEU,
						( SELECT TENVT,MAVT FROM Vattu ) VT,
						( SELECT SOLUONG, DONGIA, MAPX,MAVT FROM CTPX) CT
					WHERE PHIEU.MAPX = CT.MAPX
					AND VT.MAVT = CT.MAVT
					GROUP BY FORMAT(NGAY,'MM-yyyy'), TENVT
					ORDER BY FORMAT(NGAY,'MM-yyyy'), TENVT
		END
	END

	ELSE
	BEGIN
		IF(@TYPE = 'NHAP')
		BEGIN
				SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, 
						TENVT, 
						SUM(SOLUONG) AS TONGSOLUONG,
						SUM(SOLUONG * DONGIA) AS TRIGIA
				FROM
					( SELECT NGAY,MAPN 
						FROM PhieuNhap
						WHERE NGAY BETWEEN @DATEFROM  AND @DATETO )PHIEU,
					( SELECT TENVT,MAVT FROM Vattu ) VT,
					( SELECT SOLUONG, DONGIA, MAPN,MAVT FROM CTPN) CT
				WHERE PHIEU.MAPN = CT.MAPN
				AND VT.MAVT = CT.MAVT
				GROUP BY FORMAT(NGAY,'MM-yyyy'), TENVT
				ORDER BY FORMAT(NGAY,'MM-yyyy'), TENVT
		END
		ELSE
		BEGIN
					SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, 
						TENVT, 
						SUM(SOLUONG) AS TONGSOLUONG,
						SUM(SOLUONG * DONGIA) AS TRIGIA
					FROM
						( SELECT NGAY,MAPX
							FROM PhieuXuat
							WHERE NGAY BETWEEN @DATEFROM AND @DATETO   )PHIEU,
						( SELECT TENVT,MAVT FROM Vattu ) VT,
						( SELECT SOLUONG, DONGIA, MAPX,MAVT FROM CTPX) CT
					WHERE PHIEU.MAPX = CT.MAPX
					AND VT.MAVT = CT.MAVT
					GROUP BY FORMAT(NGAY,'MM-yyyy'), TENVT
					ORDER BY FORMAT(NGAY,'MM-yyyy'), TENVT
		END
	END
END