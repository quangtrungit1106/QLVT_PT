--Đẩy xuống 2 site 1, 2
CREATE PROC [dbo].[sp_HoatDongNhanVien](@manv int, @ngaybatdau nvarchar(10), @ngayketthuc nvarchar(10))
AS
BEGIN
	SET NOCOUNT ON
	IF (1=0) SET FMTONLY OFF

	DECLARE @tungay datetime
	DECLARE @denngay datetime
	SET @tungay = CONVERT(datetime, @ngaybatdau, 103)
	SET @denngay = CONVERT(datetime, @ngayketthuc, 103)
	SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, NGAY, PN.MAPN AS MAPHIEU, N'Nhập' AS LOAIPHIEU, TENVT AS TENVATTU, SOLUONG, DONGIA, DONGIA*SOLUONG AS TRIGIA
	INTO #TEMP_PN
	FROM (SELECT MAPN, MANV, NGAY FROM PHIEUNHAP WHERE MANV=@manv AND (NGAY BETWEEN @tungay AND @denngay)) PN
		INNER JOIN (SELECT MAPN, MAVT, DONGIA, SOLUONG FROM CTPN) CTPN ON PN.MAPN=CTPN.MAPN
		INNER JOIN (SELECT MAVT, TENVT FROM Vattu) VT ON VT.MAVT=CTPN.MAVT
	SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, NGAY, PX.MAPX AS MAPHIEU, N'Xuất' AS LOAIPHIEU, TENVT AS TENVATTU, SOLUONG, DONGIA, DONGIA*SOLUONG AS TRIGIA
	INTO #TEMP_PX
	FROM (SELECT MAPX, MANV, NGAY FROM PHIEUXUAT WHERE MANV=@manv AND (NGAY BETWEEN @tungay AND @denngay)) PX
		INNER JOIN (SELECT MAPX, MAVT, DONGIA, SOLUONG FROM CTPX) CTPX ON PX.MAPX=CTPX.MAPX
		INNER JOIN (SELECT MAVT, TENVT FROM Vattu) VT ON VT.MAVT=CTPX.MAVT
	--SELECT FORMAT(NGAY,'MM-yyyy') AS THANGNAM, NGAY, PD.MasoDDH AS MAPHIEU, N'Đặt' AS LOAIPHIEU, TENVT AS TENVATTU, SOLUONG, DONGIA, DONGIA*SOLUONG AS TRIGIA
	--INTO #TEMP_PD
	--FROM (SELECT MasoDDH, MANV, NGAY FROM DatHang WHERE MANV=@manv AND (NGAY BETWEEN @tungay AND @denngay)) PD
	--	INNER JOIN (SELECT MasoDDH, MAVT, DONGIA, SOLUONG FROM CTDDH) CTDDH ON PD.MasoDDH=CTDDH.MasoDDH
	--	INNER JOIN (SELECT MAVT, TENVT FROM Vattu) VT ON VT.MAVT=CTDDH.MAVT
	--SELECT * FROM #TEMP_PD 
	--UNION ALL 
	SELECT * FROM #TEMP_PN 
	UNION ALL 
	SELECT * FROM #TEMP_PX
	ORDER BY NGAY, MAPHIEU, TENVATTU

	DROP TABLE #TEMP_PN;
    DROP TABLE #TEMP_PX;
    --DROP TABLE #TEMP_PD;
END